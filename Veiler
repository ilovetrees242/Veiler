#!/bin/bash
PATH="$PATH:/etc/VeilerTools/usr/bin/"
PKGREPO="https://ilovetrees242.github.io/DevHelp/Website/Packages/"
VEILERTESTS=0
VEILERQUIET=0
VEILERDOC=0
YELLOW='\033[1;33m'
ORANGE='\033[0;33m'
WHITE='\033[1;37m'
GRAY='\033[0;37m'
DARKGRAY='\033[1;30m'
NC='\033[0m'

PROCESSID=""
VEILERARGS=""

package_check(){
    if [ $(id -u) != 0 ]; then
        echo -e "${RED}You are not root! run as root with: sudo $0${NC}"
        exit 1
    fi
    while true; do
        printf "\r${ORANGE}Checking if required packages are installed on your computer   ${NC}"; sleep 0.2
        printf "\r${ORANGE}Checking if required packages are installed on your computer.  ${NC}"; sleep 0.2
        printf "\r${ORANGE}Checking if required packages are installed on your computer.. ${NC}"; sleep 0.2
        printf "\r${ORANGE}Checking if required packages are installed on your computer...${NC}"; sleep 0.2
    done &
    PROCESSID=$!
    for PACKAGE in find bash wget awk gcc make patch grep tar readelf; do
        $PACKAGE --version &> /dev/null 
        if [ $? -eq 127 ]; then
            echo -e "${YELLOW}$PACKAGE is not installed on your system! Veiler will use prebuilt binaries from the tool directory.${NC}"
            PATH=$PATH:/usr/lib/Veiler/Tools/usr/bin/
        fi
        sleep 0.1
    done && kill $PROCESSID && printf "\n${YELLOW}Done!${NC}\n"     
}
clean(){
    rm -rvf /var/cache/Veiler/*
}
for(( i=1; i <= $#; i++ )){
    case ${!i} in
        --quiet)
            if [ $VEILERQUIET -eq 0 ]; then
                set -- ${@:1:$((i-1))} ${@:$((i+1))}
                VEILERQUIET=1
                i=0
            elif [ $VEILERQUIET -eq 1 ]; then
                echo -e "${Yellow}Quiet mode already enabled!${NC}"; exit 1
            fi
        ;;
        --documentation)
            if [ $VEILERDOC -eq 0 ]; then 
                set -- ${@:1:$((i-1))} ${@:$((i+1))}
                VEILERDOC=1
                i=0
            elif [ $VEILERDOC -eq 1 ]; then
                echo -e "${YELLOW}Documentation already enabled!${NC}"; exit 1
            fi
        ;;
        --tests)
            if [ $VEILERTESTS -eq 0 ]; then
                set -- ${@:1:$((i-1))} ${@:$((i+1))}
                VEILERTESTS=1
                i=0
            elif [ $VEILERTESTS -eq 1 ]; then
                echo -e "${YELLOW}Tests are already enabled!${NC}"; exit 1
            fi
        ;;
    esac
}
case $1 in
	unveil)
        package_check
        if [ -z "$2" ]; then
            echo -e "${YELLOW}Package name not specified!${NC}"
            exit 1
        fi
        shift 
        echo -e "${WHITE}Packages to be installed: $@${NC}"
        if [ $VEILERQUIET -eq 0 ]; then
            if [ $# -ge 2 ]; then
                VEILERARGS=$@
                for(( i=0; i < $#; i++ )){
                    echo -e "${YELLOW}Changing directory to /var/cache/Veiler...${NC}"
                    cd /var/cache/Veiler && clean
                    PREVUSERPWD=$PWD
                    echo -e "${YELLOW}Checking if packages exist...${NC}"
                    wget $PKGREPO$1.tar.gz 
                    if [ $? -eq 0 ]; then
                        echo -e "${YELLOW}->Package ${WHITE}$1${YELLOW} found${NC}"
                    elif [ $? -eq 8 ]; then
                        echo -e "${YELLOW}->Package ${ORANGE}$1${YELLOW} not found!${NC}"
                        exit 1
                    else
                        echo -e "${YELLOW}->An unknown error occured while fetching the packages.${NC}"
                        exit 1
                    fi
                }
                set -- $VEILERARGS
                # TO DO: loop for extracting and building each package one by one
                    # xxx
            else
                echo -e "${YELLOW}Changing directory to /var/cache/Veiler...${NC}"
                pushd /var/cache/Veiler && clean
                echo -e "${ORANGE}Checking if package ${YELLOW}$1${ORANGE} exists...${NC}"
                wget "$PKGREPO$1.tar.gz" 
                case $? in 
                    8)
                        echo -e "${YELLOW}Package ${ORANGE}$1${YELLOW}not found!${NC}"
                        exit 1
                    ;;
                    0)
                        echo -e "\n${ORANGE}Package ${WHITE}$1${ORANGE}found!${NC}"
				        echo -e "${YELLOW}Installing ${WHITE}$1${YELLOW} in${NC}"
				        for i in 1 2 3 4 5 ; do
                            printf "${WHITE}%d${NC}" "$i"
					        for j in 1 2 3; do
                                sleep 0.1
                                printf "${YELLOW}.${NC}"
                            done
                            sleep 1
				        done
                        echo
                        echo -e "${YELLOW}Extracting the build tarball...${NC}"
                        tar xvf $1.tar.gz
                        pushd $1
                            source ./MOONBUILD chkdeps
                            source ./MOONBUILD build
                            trap 'echo -e "${YELLOW}An error was encountered while building $1. Not installing $1${NC}"; exit 1' ERR
                            source ./MOONBUILD install
                            trap - ERR
                        popd
                    ;;
                    *)
                        echo -e "${YELLOW}An unknown error was encountered while downloading the build tarball.${NC}"
                        popd
                        exit 1
                    ;;
                esac
                popd
            fi
        elif [ $VEILERQUIET -eq 1 ]; then
            echo -e "${YELLOW}Changing directory to /var/cache/Veiler...${NC}"
            pushd /var/cache/Veiler &> /dev/null && clean &> /dev/null
            if [ $# -ge 2 ]; then
                # TO DO: Add commands for fetching and building multiple packages
                echo "DEBUG : $@"
            else
                while true; do
                    echo -ne "\r${ORANGE}Checking if package ${YELLOW}$1${ORANGE} exists   ${NC}"; sleep 0.2; 
                    echo -ne "\r${ORANGE}Checking if package ${YELLOW}$1${ORANGE} exists.  ${NC}"; sleep 0.2; 
                    echo -ne "\r${ORANGE}Checking if package ${YELLOW}$1${ORANGE} exists.. ${NC}"; sleep 0.2; 
                    echo -ne "\r${ORANGE}Checking if package ${YELLOW}$1${ORANGE} exists...${NC}"; sleep 0.2; 
                done &
                PROCESSID=$!
	    	    wget "$PKGREPO$1.tar.gz" &> /dev/null
                case $? in
		    	    8)
                        kill $PROCESSID
			    	    echo -e "${YELLOW}Package ${ORANGE}$1${YELLOW}not found!${NC}"
                        exit 1
                    ;;
			        0)  
                        kill $PROCESSID
                        echo -e "\n${ORANGE}Package ${WHITE}$1${WHITE} found!${NC}"
				        echo -e "${YELLOW}Installing ${WHITE}$1${YELLOW} in${NC}"
				        for i in 1 2 3 4 5 ; do
                            printf "${WHITE}%d${NC}" "$i"
					        for j in 1 2 3; do
                                sleep 0.1
                                printf "${YELLOW}.${NC}"
                            done
                            sleep 1
				        done
                        echo
                        trap 'echo -e "${ORANGE}Could not extract the build tarball.${NC}; kill $PROCESSID; exit 1;"' ERR
                        while true; do
                            echo -ne "\r${ORANGE}Extracting the build tarball   ${NC}"; sleep 0.2; 
                            echo -ne "\r${ORANGE}Extracting the build tarball.  ${NC}"; sleep 0.2; 
                            echo -ne "\r${ORANGE}Extracting the build tarball.. ${NC}"; sleep 0.2; 
                            echo -ne "\r${ORANGE}Extracting the build tarball...${NC}"; sleep 0.2; 
                        done &
                        PROCESSID="$!"
                        tar xf $1.tar.gz 
                        kill $PROCESSID; echo -e "\n${WHITE}Done!${NC}"
		    		    pushd "$1" &> /dev/null
                            source ./MOONBUILD chkdeps
			    	        source ./MOONBUILD build
                            source ./MOONBUILD install
			            popd &> /dev/null
                        rm -rf "$1"; rm -f "$1.tar.gz" "$1.tar.gz.*"
				    ;;
                    *)
                        echo -e "${YELLOW}An unknown error occured. Manual intervention is required. Please use verbose mode and inspect the package manager script manually.${NC}"
                        exit 1
                    ;;
		        esac
                popd
            fi
        fi
    ;;
	veil)
        package_check
        if [ -z "$2" ]; then
            echo -e "${YELLOW}Package name not specified!${NC}"
            exit 1
        fi
        shift
        if [ "$VEILERQUIET" -eq 1 ]; then
            echo -e "${YELLOW}Changing directory to /var/cache/Veiler...${NC}"
            pushd /var/cache/Veiler &> /dev/null && clean &> /dev/null
            if [ $# -ge 2 ]; then
                echo "\033[s"
                while true; do
                    echo -ne "\r${ORANGE}Checking if packages exist   ${NC}"; sleep 0.2; echo "\033[u"
                    echo -ne "\r${ORANGE}Checking if packages exist.  ${NC}"; sleep 0.2; echo "\033[u"
                    echo -ne "\r${ORANGE}Checking if packages exist.. ${NC}"; sleep 0.2; echo "\033[u"
                    echo -ne "\r${ORANGE}Checking if packages exist...${NC}"; sleep 0.2; echo "\033[u"
                done &
                PROCESSID=$!
                wget "$PKGREPO$1.tar.gz" &> /dev/null 
                if [ $? -eq 8 ]; then
                    echo -e "${YELLOW}Package $1 not found!${NC}"
                elif [ $? -eq 0 ]; then
                    echo -e "${WHITE}->${YELLOW}Package ${WHITE}$1${YELLOW} found${NC}"
                else
                    echo -e "${YELLOW}An unknown error was encountered while checking if packages exist. Manual intervention required.${NC}"
                fi
            else
                while true; do
		            echo -ne "\r${ORANGE}Checking if the package ${YELLOW}$1${ORANGE} exists   ${NC}"; sleep 0.2
		            echo -ne "\r${ORANGE}Checking if the package ${YELLOW}$1${ORANGE} exists.  ${NC}"; sleep 0.2
		            echo -ne "\r${ORANGE}Checking if the package ${YELLOW}$1${ORANGE} exists.. ${NC}"; sleep 0.2
		            echo -ne "\r${ORANGE}Checking if the package ${YELLOW}$1${ORANGE} exists...${NC}"; sleep 0.2
                done &
                PROCESSID=$!
		        wget "$PKGREPO$1.tar.gz" &> /dev/null && kill $PROCESSID && echo
		        case $? in
		            8)
				        echo -e "${YELLOW}Package ${WHITE}$1${WHITE}does not exist!${NC}"
		    	    ;;
                    0)
                    echo -e "\n${ORANGE}Package ${WHITE}$1${WHITE} found!${NC}"
			        echo -e "${YELLOW}Uninstalling ${WHITE}$1${YELLOW} in${NC}"
			        for i in 1 2 3 4 5 ; do
                        printf "${WHITE}%d${NC}" "$i"
			            for j in 1 2 3; do
                            sleep 0.1
                            printf "${YELLOW}.${NC}"
                        done
                        sleep 1
			        done
                    echo
                    while true; do
                        echo -ne "\r${ORANGE}Extracting the build tarball   ${NC}"; sleep 0.2
                        echo -ne "\r${ORANGE}Extracting the build tarball.  ${NC}"; sleep 0.2
                        echo -ne "\r${ORANGE}Extracting the build tarball.. ${NC}"; sleep 0.2
                        echo -ne "\r${ORANGE}Extracting the build tarball...${NC}"; sleep 0.2
                    done &
                    PROCESSID=$!
                    tar xf "$1.tar.gz" && kill $PROCESSID && echo -e "\n${YELLOW}->Successfully extracted $1.tar.gz${NC}"
					pushd "$1" &> /dev/null
				        source ./MOONBUILD uninstall
				    popd &> /dev/null
			        ;;
                    *)
                        echo -e "${YELLOW}An unknown error has been encountered. Manual intervention is required.${NC}"
                        popd &> /dev/null
                        exit 1
                    ;;
		        esac
            popd &> /dev/null
            fi
        else
            echo -e "${YELLOW}Changing directory to /var/cache/Veiler..."; sleep 2
            pushd /var/cache/Veiler && clean
            if [ $# -ge 2 ]; then
                # TO DO : Build commands for multiple packages
                xx
            else
                echo -e "${ORANGE}Checking if the package ${YELLOW}$1${ORANGE} exists...${NC}"; sleep 0.2
                PROCESSID="$!"
                wget $PKGREPO$1.tar.gz
                case $? in 
                    8)
                        echo -e "${YELLOW}Package ${WHITE}$1${YELLOW} does not exist!${NC}"
                        exit 1
                    ;;                    
                    0)
                        echo -e "\n${ORANGE}Package ${WHITE}$1${WHITE} found!${NC}"
    			        echo -e "${YELLOW}Uninstalling ${WHITE}$1${YELLOW} in${NC}"
	    		        for i in 1 2 3 4 5 ; do
                            printf "${WHITE}%d${NC}" "$i"
			                for j in 1 2 3; do
                                sleep 0.1
                                printf "${YELLOW}.${NC}"
                            done
                        sleep 1
			            done
                        echo
                        printf "${YELLOW}Extracting the build tarball now...${NC}"
                        tar xvf "$1.tar.gz"
                        pushd "$1"
                            source ./MOONBUILD uninstall
                        popd
                    ;;
                    *)
                        echo -e "${ORANGE}An unknown error was encountered while downloading the build tarball.${NC}"
                        exit 1
                esac
            fi
         fi
	;;
	strengthen)
        # TO DO: Later, add a feature to update packages installed on system if new version has been released and is greater than installed version
        xx
	;;
	help)
		echo -e "${WHITE}$0 Usage: $0 <OPTIONS> <COMMAND>${NC}"
		echo -e "${WHITE}$0 unveil|veil <OPTIONS> [PACKAGE]${NC}"
		echo -e "${WHITE}$0 Options:" 
	   echo -e "${GRAY}--verbose${NC}${WHITE} : Displays verbose output"
       echo -e "${GRAY}--quiet${NC}${WHITE} : Displays quiet output, not too detailed."
	   echo -e "${GRAY}--documentation${NC}${WHITE} : Enables documentation (this might install extra dependencies)"
	   echo -e "${GRAY}--test${NC}${WHITE}: Enables test harnesses" 
		echo -e "${WHITE}$0 unveil: Installs a package from source.${NC}"
		echo -e "${WHITE}$0 veil  : Uninstalls a package installed on the system${NC}"
		echo -e "${WHITE}$0 strengthen: Updates all packages installed on the system${NC}"
		echo -e "${WHITE}$0 help: Displays this output${NC}"
        echo -e "${WHITE}$0 version: Display package manager version"
		
	;;
    version)
            echo -e "Veiler development version. V"
    ;;
	*)
        echo -e "${WHITE}Invalid action ${YELLOW}$1${WHITE} specified!${NC}"
        $0 help
	;;
esac
